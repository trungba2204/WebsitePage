<header class="header">
  <div class="container">
    <nav class="navbar">
      <!-- Logo -->
      <div class="navbar-brand">
        <a routerLink="/" class="logo">
          <i class="bi bi-shop"></i>
          <span>MiniStore</span>
        </a>
      </div>

      <!-- Desktop Menu -->
      <ul class="navbar-menu">
        <li><a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">Trang chủ</a></li>
        <li><a routerLink="/products" routerLinkActive="active">Sản phẩm</a></li>
        <li><a routerLink="/promotions" routerLinkActive="active">Mã giảm giá</a></li>
        <li><a routerLink="/blogs" routerLinkActive="active">Blog</a></li>
        <li><a routerLink="/about" routerLinkActive="active">Giới thiệu</a></li>
        <li><a routerLink="/contact" routerLinkActive="active">Liên hệ</a></li>
        @if (authService.isAuthenticated()) {
          <li><a routerLink="/orders" routerLinkActive="active">Đơn hàng</a></li>
        }
      </ul>

      <!-- Search Bar -->
      <div class="search-bar">
        <div class="search-input-group">
          <input 
            type="text" 
            class="search-input" 
            placeholder="Tìm kiếm sản phẩm..."
            [(ngModel)]="searchQuery"
            (keyup.enter)="onSearch()"
            (input)="onSearchInput()">
          <button class="search-btn" (click)="onSearch()" title="Tìm kiếm">
            <i class="bi bi-search"></i>
          </button>
        </div>
        
        <!-- Search Results Dropdown -->
        @if (showSearchResults && searchResults.length > 0) {
          <div class="search-results">
            @for (product of searchResults; track product.id) {
              <a [routerLink]="['/products', product.id]" class="search-result-item" (click)="closeSearchResults()">
                <img [src]="product.imageUrl" [alt]="product.name" class="search-result-image">
                <div class="search-result-info">
                  <h6 class="search-result-name">{{ product.name }}</h6>
                  <span class="search-result-price">{{ formatPrice(product.price) }}</span>
                </div>
              </a>
            }
            <div class="search-result-footer">
              <a [routerLink]="['/products']" [queryParams]="{search: searchQuery}" (click)="closeSearchResults()">
                Xem tất cả kết quả cho "{{ searchQuery }}"
              </a>
            </div>
          </div>
        }
        
        @if (showSearchResults && searchQuery && searchResults.length === 0 && !isSearching) {
          <div class="search-results">
            <div class="search-no-results">
              <p>Không tìm thấy sản phẩm nào cho "{{ searchQuery }}"</p>
              <a [routerLink]="['/products']" (click)="closeSearchResults()">
                Xem tất cả sản phẩm
              </a>
            </div>
          </div>
        }
      </div>

      <!-- Actions -->
      <div class="navbar-actions">

        <!-- Cart -->
        <a routerLink="/cart" class="icon-btn cart-btn" title="Giỏ hàng">
          <i class="bi bi-cart3"></i>
          @if (cartService.cartItemCount() > 0) {
            <span class="badge">{{ cartService.cartItemCount() }}</span>
          }
        </a>

        <!-- User Menu -->
        @if (authService.isAuthenticated()) {
          <div class="user-menu" [class.open]="isUserMenuOpen">
            <button 
              class="icon-btn user-btn" 
              title="Tài khoản"
              (click)="toggleUserMenu()"
              (blur)="onUserMenuBlur()">
              <img [src]="avatarUrl()" [alt]="authService.currentUser()?.firstName" class="user-avatar" (load)="onImageLoad($event)" (error)="onImageError($event)" style="display: none;">
              <i class="bi bi-person-circle" style="display: block;"></i>
            </button>
            <div class="dropdown" [class.show]="isUserMenuOpen">
              <div class="user-info">
                <div class="user-name">{{ authService.currentUser()?.firstName }} {{ authService.currentUser()?.lastName }}</div>
                <div class="user-email">{{ authService.currentUser()?.email }}</div>
              </div>
              <hr class="dropdown-divider">
              <a routerLink="/profile" (click)="closeUserMenu()">
                <i class="bi bi-person"></i> Tài khoản
              </a>
              <a routerLink="/orders" (click)="closeUserMenu()">
                <i class="bi bi-box-seam"></i> Đơn hàng
              </a>
              <a (click)="openAvatarModal()" class="avatar-change">
                <i class="bi bi-camera"></i> Thay đổi ảnh đại diện
              </a>
              <a (click)="logout(); closeUserMenu()" class="logout">
                <i class="bi bi-box-arrow-right"></i> Đăng xuất
              </a>
            </div>
          </div>
        } @else {
          <a routerLink="/login" class="btn btn-primary btn-sm">
            Đăng nhập
          </a>
        }

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-btn" (click)="toggleMenu()">
          <i class="bi" [ngClass]="isMenuOpen ? 'bi-x' : 'bi-list'"></i>
        </button>
      </div>
    </nav>

    <!-- Mobile Menu -->
    @if (isMenuOpen) {
      <div class="mobile-menu">
        <a routerLink="/" (click)="toggleMenu()">Trang chủ</a>
        <a routerLink="/products" (click)="toggleMenu()">Sản phẩm</a>
        <a routerLink="/promotions" (click)="toggleMenu()">Mã giảm giá</a>
        <a routerLink="/blogs" (click)="toggleMenu()">Blog</a>
        <a routerLink="/about" (click)="toggleMenu()">Giới thiệu</a>
        <a routerLink="/contact" (click)="toggleMenu()">Liên hệ</a>
        @if (authService.isAuthenticated()) {
          <a routerLink="/profile" (click)="toggleMenu()">Tài khoản</a>
          <a routerLink="/orders" (click)="toggleMenu()">Đơn hàng</a>
          <a (click)="logout(); toggleMenu()">Đăng xuất</a>
        }
      </div>
    }
  </div>
</header>

<!-- Avatar Upload Modal -->
@if (showAvatarModal) {
  <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">
            <i class="bi bi-camera me-2"></i>
            Thay đổi ảnh đại diện
          </h5>
          <button 
            type="button" 
            class="btn-close" 
            (click)="closeAvatarModal()"
            [disabled]="isUploadingAvatar">
          </button>
        </div>
        <div class="modal-body pt-0">
          <div class="upload-section">
            <div class="upload-area" [class.uploading]="isUploadingAvatar">
              <input 
                type="file" 
                id="avatarUpload" 
                accept="image/jpeg,image/png,image/gif,image/webp"
                (change)="onAvatarFileSelected($event)"
                [disabled]="isUploadingAvatar"
                style="display: none;">
              
              <label for="avatarUpload" class="upload-label">
                @if (isUploadingAvatar) {
                  <div class="upload-content">
                    <div class="spinner-border text-primary mb-3" role="status">
                      <span class="visually-hidden">Đang tải lên...</span>
                    </div>
                    <p class="upload-text">Đang tải lên ảnh...</p>
                  </div>
                } @else {
                  <div class="upload-content">
                    <i class="bi bi-cloud-upload upload-icon"></i>
                    <p class="upload-text">Nhấn để chọn ảnh hoặc kéo thả vào đây</p>
                    <small class="text-muted">JPG, PNG, GIF, WEBP tối đa 5MB (không hỗ trợ HEIC)</small>
                  </div>
                }
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="closeAvatarModal()"
            [disabled]="isUploadingAvatar">
            <i class="bi bi-x-circle me-1"></i>
            Hủy bỏ
          </button>
        </div>
      </div>
    </div>
  </div>
}

