<div class="profile-page">
  <div class="container">
    <!-- Header -->
    <div class="profile-header">
      <h1>Tài khoản của tôi</h1>
      <p>Quản lý thông tin cá nhân và theo dõi đơn hàng</p>
    </div>

    @if (user) {
      <div class="row">
        <!-- Profile Info -->
        <div class="col-lg-4">
          <div class="profile-card">
            <div class="profile-avatar">
              <div class="avatar-circle">
                @if (user.avatar) {
                  <img 
                    [src]="user.avatar" 
                    [alt]="user.firstName" 
                    class="avatar-image"
                    appImageFallback
                    [fallbackImage]="getFallbackImage()">
                } @else {
                  <i class="bi bi-person-circle"></i>
                }
              </div>
              <input 
                type="file" 
                id="avatar-upload" 
                accept="image/*" 
                (change)="onAvatarChange($event)" 
                style="display: none;">
              <button 
                type="button" 
                class="btn btn-outline-primary btn-sm mt-2"
                (click)="triggerFileInput()"
                [disabled]="isUploadingAvatar">
                @if (isUploadingAvatar) {
                  <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                  Đang tải...
                } @else {
                  <i class="bi bi-camera me-1"></i>
                  Đổi ảnh
                }
              </button>
            </div>
            
            <div class="profile-info">
              @if (!isEditing) {
                <h3>{{ user.firstName }} {{ user.lastName }}</h3>
                <p class="text-muted">{{ user.email }}</p>
                @if (user.phone) {
                  <p class="text-muted">
                    <i class="bi bi-telephone me-2"></i>
                    {{ user.phone }}
                  </p>
                }
                <button class="btn btn-primary" (click)="toggleEdit()">
                  <i class="bi bi-pencil me-2"></i>
                  Chỉnh sửa thông tin
                </button>
              } @else {
                <form (ngSubmit)="saveProfile()">
                  <div class="form-group mb-3">
                    <label class="form-label">Họ</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      [(ngModel)]="editForm.lastName"
                      name="lastName"
                      placeholder="Nhập họ">
                  </div>
                  
                  <div class="form-group mb-3">
                    <label class="form-label">Tên</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      [(ngModel)]="editForm.firstName"
                      name="firstName"
                      placeholder="Nhập tên">
                  </div>
                  
                  <div class="form-group mb-3">
                    <label class="form-label">Email</label>
                    <input 
                      type="email" 
                      class="form-control" 
                      [(ngModel)]="editForm.email"
                      name="email"
                      placeholder="Nhập email">
                  </div>
                  
                  <div class="form-group mb-3">
                    <label class="form-label">Số điện thoại</label>
                    <input 
                      type="tel" 
                      class="form-control" 
                      [(ngModel)]="editForm.phone"
                      name="phone"
                      placeholder="Nhập số điện thoại">
                  </div>
                  
                  <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-check me-2"></i>
                      Lưu thay đổi
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" (click)="toggleEdit()">
                      <i class="bi bi-x me-2"></i>
                      Hủy
                    </button>
                  </div>
                </form>
              }
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="stats-card">
            <h4>Thống kê mua sắm</h4>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-number">{{ recentOrders.length }}</div>
                <div class="stat-label">Đơn hàng</div>
              </div>
              <div class="stat-item">
                <div class="stat-number">
                  {{ getTotalSpent() }}
                </div>
                <div class="stat-label">Tổng chi tiêu</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Orders -->
        <div class="col-lg-8">
          <div class="orders-card">
            <div class="card-header">
              <h4>Đơn hàng gần đây</h4>
              <a routerLink="/orders" class="btn btn-outline-primary btn-sm">
                Xem tất cả
                <i class="bi bi-arrow-right ms-1"></i>
              </a>
            </div>
            
            <div class="card-body">
              @if (isLoading) {
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                  </div>
                  <p class="mt-2">Đang tải đơn hàng...</p>
                </div>
              } @else if (recentOrders.length > 0) {
                <div class="orders-list">
                  @for (order of recentOrders; track order.id) {
                    <div class="order-item">
                      <div class="order-info">
                        <div class="order-number">
                          <strong>#{{ order.orderNumber }}</strong>
                          <span class="order-date">{{ formatDate(order.orderDate) }}</span>
                        </div>
                        <div class="order-status">
                          <span class="status-badge" [ngClass]="getStatusClass(order.status)">
                            {{ getStatusText(order.status) }}
                          </span>
                        </div>
                      </div>
                      
                      <div class="order-items">
                        @for (item of order.items; track item.id) {
                          <div class="order-item-product">
                            <img [src]="item.product.imageUrl" [alt]="item.product.name" class="product-image">
                            <div class="product-info">
                              <h6 class="product-name">{{ item.product.name }}</h6>
                              <span class="product-quantity">x{{ item.quantity }}</span>
                            </div>
                            <div class="product-price">{{ formatPrice(item.price * item.quantity) }}</div>
                          </div>
                        }
                      </div>
                      
                      <div class="order-footer">
                        <div class="order-total">
                          @if (order.discountCode && order.discountAmount) {
                            <div class="discount-badge mb-2">
                              <span class="badge bg-success">
                                <i class="bi bi-ticket-perforated me-1"></i>
                                {{ order.discountCode }}
                              </span>
                              <small class="text-success ms-2">
                                <i class="bi bi-gift me-1"></i>
                                Tiết kiệm {{ formatPrice(order.discountAmount) }}
                              </small>
                            </div>
                          }
                          <div class="total-amount">
                            <strong class="{{ order.discountCode ? 'text-success' : 'text-primary' }}">
                              Tổng: {{ formatPrice(order.totalAmount) }}
                            </strong>
                            @if (order.discountCode && order.discountAmount) {
                              <small class="text-muted d-block text-decoration-line-through">
                                Giá gốc: {{ formatPrice(order.originalAmount || order.totalAmount) }}
                              </small>
                            }
                          </div>
                        </div>
                        <div class="order-actions">
                          <a [routerLink]="['/orders', order.id]" class="btn btn-outline-primary btn-sm">
                            Xem chi tiết
                          </a>
                          @if (order.status === 'PENDING') {
                            <button class="btn btn-outline-danger btn-sm ms-2">
                              Hủy đơn
                            </button>
                          }
                        </div>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-orders">
                  <i class="bi bi-box-seam"></i>
                  <h5>Chưa có đơn hàng nào</h5>
                  <p>Bạn chưa có đơn hàng nào. Hãy bắt đầu mua sắm!</p>
                  <a routerLink="/products" class="btn btn-primary">
                    <i class="bi bi-bag me-2"></i>
                    Mua sắm ngay
                  </a>
                </div>
              }
            </div>
          </div>

          <!-- Account Actions -->
          <div class="account-actions mt-4">
            <div class="row">
              <div class="col-md-6">
                <div class="action-card">
                  <div class="action-icon">
                    <i class="bi bi-shield-check"></i>
                  </div>
                  <div class="action-content">
                    <h5>Bảo mật tài khoản</h5>
                    <p>Đổi mật khẩu và cài đặt bảo mật</p>
                    <button class="btn btn-outline-primary btn-sm">
                      Cài đặt bảo mật
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="action-card">
                  <div class="action-icon">
                    <i class="bi bi-heart"></i>
                  </div>
                  <div class="action-content">
                    <h5>Sản phẩm yêu thích</h5>
                    <p>Xem danh sách sản phẩm đã lưu</p>
                    <button class="btn btn-outline-primary btn-sm">
                      Xem danh sách
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    } @else {
      <div class="text-center py-5">
        <i class="bi bi-exclamation-circle text-muted" style="font-size: 4rem;"></i>
        <h3 class="mt-3">Không tìm thấy thông tin người dùng</h3>
        <p class="text-muted">Vui lòng đăng nhập để xem thông tin tài khoản.</p>
        <a routerLink="/login" class="btn btn-primary">Đăng nhập</a>
      </div>
    }
  </div>
</div>
