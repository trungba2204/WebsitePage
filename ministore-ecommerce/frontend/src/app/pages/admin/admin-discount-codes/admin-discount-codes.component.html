<div class="admin-discount-codes-page">
  <div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Quản lý mã giảm giá</h2>
      <button 
        class="btn btn-primary"
        (click)="showCreateFormDialog()">
        <i class="bi bi-plus-circle me-2"></i>
        Tạo mã giảm giá
      </button>
    </div>

    <!-- Loading -->
    @if (isLoading) {
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Đang tải...</span>
        </div>
        <p class="mt-3">Đang tải danh sách mã giảm giá...</p>
      </div>
    } @else {
      <!-- Discount Codes Table -->
      <div class="card">
        <div class="card-body">
          @if (discountCodes.length === 0) {
            <div class="empty-state text-center py-5">
              <i class="bi bi-ticket-perforated text-muted" style="font-size: 4rem;"></i>
              <h4 class="mt-3">Chưa có mã giảm giá nào</h4>
              <p class="text-muted">Hãy tạo mã giảm giá đầu tiên để bắt đầu</p>
              <button 
                class="btn btn-primary"
                (click)="showCreateFormDialog()">
                <i class="bi bi-plus-circle me-2"></i>
                Tạo mã giảm giá
              </button>
            </div>
          } @else {
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Mã giảm giá</th>
                    <th>Loại giảm giá</th>
                    <th>Giá trị</th>
                    <th>Đơn hàng tối thiểu</th>
                    <th>Thời gian</th>
                    <th>Sử dụng</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                  </tr>
                </thead>
                <tbody>
                  @for (code of discountCodes; track code.id) {
                    <tr>
                      <td>
                        <code class="text-primary">{{ code.code }}</code>
                      </td>
                      <td>
                        <span class="badge" 
                              [ngClass]="code.discountType === 'PERCENTAGE' ? 'bg-info' : 'bg-warning'">
                          {{ code.discountType === 'PERCENTAGE' ? 'Phần trăm' : 'Số tiền cố định' }}
                        </span>
                      </td>
                      <td>
                        @if (code.discountType === 'PERCENTAGE') {
                          {{ code.discountValue }}%
                        } @else {
                          {{ formatPrice(code.discountValue) }}
                        }
                        @if (code.maxDiscountAmount) {
                          <br><small class="text-muted">(Tối đa: {{ formatPrice(code.maxDiscountAmount) }})</small>
                        }
                      </td>
                      <td>
                        @if (code.minOrderAmount) {
                          {{ formatPrice(code.minOrderAmount) }}
                        } @else {
                          <span class="text-muted">Không giới hạn</span>
                        }
                      </td>
                      <td>
                        <small>
                          <div>Từ: {{ formatDate(code.startDate) }}</div>
                          <div>Đến: {{ formatDate(code.endDate) }}</div>
                        </small>
                      </td>
                      <td>
                        @if (code.usageLimit) {
                          {{ code.usedCount }} / {{ code.usageLimit }}
                        } @else {
                          {{ code.usedCount }} / ∞
                        }
                      </td>
                      <td>
                        <span [ngClass]="getStatusClass(code)">
                          {{ getStatusText(code) }}
                        </span>
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          <button 
                            class="btn btn-sm btn-outline-primary"
                            (click)="showEditForm(code)">
                            <i class="bi bi-pencil"></i>
                          </button>
                          <button 
                            class="btn btn-sm btn-outline-danger"
                            (click)="deleteDiscountCode(code)">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
    }

    <!-- Create/Edit Form Modal -->
    @if (showCreateForm) {
      <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                {{ isEditing ? 'Chỉnh sửa mã giảm giá' : 'Tạo mã giảm giá mới' }}
              </h5>
              <button 
                type="button" 
                class="btn-close" 
                (click)="hideCreateForm()">
              </button>
            </div>
            <form (ngSubmit)="onSubmit()" #discountForm="ngForm">
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="code" class="form-label">Mã giảm giá *</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="code"
                      [(ngModel)]="formData.code" 
                      name="code"
                      placeholder="VD: SALE10, WELCOME10"
                      required>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="discountType" class="form-label">Loại giảm giá *</label>
                    <select 
                      class="form-select" 
                      id="discountType"
                      [(ngModel)]="formData.discountType" 
                      name="discountType"
                      required>
                      <option value="PERCENTAGE">Phần trăm (%)</option>
                      <option value="FIXED_AMOUNT">Số tiền cố định (VNĐ)</option>
                    </select>
                  </div>
                </div>


                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="discountValue" class="form-label">
                      Giá trị giảm giá * 
                      <small class="text-muted">
                        ({{ formData.discountType === 'PERCENTAGE' ? 'Phần trăm' : 'VNĐ' }})
                      </small>
                    </label>
                    <input 
                      type="number" 
                      class="form-control" 
                      id="discountValue"
                      [(ngModel)]="formData.discountValue" 
                      name="discountValue"
                      min="0"
                      [max]="formData.discountType === 'PERCENTAGE' ? '100' : null"
                      step="0.01"
                      required>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="maxDiscountAmount" class="form-label">
                      Giảm giá tối đa
                      <small class="text-muted">(VNĐ - tùy chọn)</small>
                    </label>
                    <input 
                      type="number" 
                      class="form-control" 
                      id="maxDiscountAmount"
                      [(ngModel)]="formData.maxDiscountAmount" 
                      name="maxDiscountAmount"
                      min="0"
                      step="1000"
                      placeholder="Không giới hạn">
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="minOrderAmount" class="form-label">
                      Đơn hàng tối thiểu
                      <small class="text-muted">(VNĐ - tùy chọn)</small>
                    </label>
                    <input 
                      type="number" 
                      class="form-control" 
                      id="minOrderAmount"
                      [(ngModel)]="formData.minOrderAmount" 
                      name="minOrderAmount"
                      min="0"
                      step="1000"
                      placeholder="Không giới hạn">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="usageLimit" class="form-label">
                      Giới hạn sử dụng
                      <small class="text-muted">(lượt - tùy chọn)</small>
                    </label>
                    <input 
                      type="number" 
                      class="form-control" 
                      id="usageLimit"
                      [(ngModel)]="formData.usageLimit" 
                      name="usageLimit"
                      min="1"
                      placeholder="Không giới hạn">
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="startDate" class="form-label">Ngày bắt đầu *</label>
                    <input 
                      type="date" 
                      class="form-control" 
                      id="startDate"
                      [(ngModel)]="formData.startDate" 
                      name="startDate"
                      required>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="endDate" class="form-label">Ngày kết thúc *</label>
                    <input 
                      type="date" 
                      class="form-control" 
                      id="endDate"
                      [(ngModel)]="formData.endDate" 
                      name="endDate"
                      required>
                  </div>
                </div>

                <div class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="isActive"
                    [(ngModel)]="formData.isActive" 
                    name="isActive">
                  <label class="form-check-label" for="isActive">
                    Kích hoạt mã giảm giá
                  </label>
                </div>
              </div>
              <div class="modal-footer">
                <button 
                  type="button" 
                  class="btn btn-secondary" 
                  (click)="hideCreateForm()">
                  Hủy
                </button>
                <button 
                  type="submit" 
                  class="btn btn-primary"
                  [disabled]="isCreating">
                  @if (isCreating) {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Đang xử lý...
                  } @else {
                    {{ isEditing ? 'Cập nhật' : 'Tạo mới' }}
                  }
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    }
  </div>
</div>
